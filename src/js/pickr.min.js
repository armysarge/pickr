import*as _ from"./utils/utils";import{parseToHSVA}from"./utils/color";import{HSVaColor}from"./utils/hsvacolor";import Moveable from"./libs/moveable";import Selectable from"./libs/selectable";import buildPickr from"./template";import{createPopper}from"nanopop";export default class Pickr{static utils=_;static version=VERSION;static I18N_DEFAULTS={"ui:dialog":"color picker dialog","btn:toggle":"toggle color picker dialog","btn:swatch":"color swatch","btn:last-color":"use previous color","btn:save":"Save","btn:cancel":"Cancel","btn:clear":"Clear","aria:btn:save":"save and close","aria:btn:cancel":"cancel and close","aria:btn:clear":"clear and close","aria:input":"color input field","aria:palette":"color selection area","aria:hue":"hue selection slider","aria:opacity":"selection slider","aria:gradient:enable":"enable gradient mode","aria:gradient:angle":"gradient angle","aria:gradient:color1":"gradient color 1","aria:gradient:color2":"gradient color 2"};static DEFAULT_OPTIONS={appClass:null,theme:"classic",useAsButton:!1,padding:8,disabled:!1,comparison:!0,closeOnScroll:!1,outputPrecision:0,lockOpacity:!1,autoReposition:!0,container:"body",components:{interaction:{}},gradient:{enabled:!1,type:"linear",angle:90,colors:["#000000","#ffffff"]},i18n:{},swatches:null,inline:!1,sliders:null,default:"#42445a",defaultRepresentation:null,position:"bottom-middle",adjustableNumbers:!0,showAlways:!1,closeWithKey:"Escape"};_initializingActive=!0;_recalc=!0;_nanopop=null;_root=null;_color=HSVaColor();_lastColor=HSVaColor();_swatchColors=[];_setupAnimationFrame=null;_eventListener={init:[],save:[],hide:[],show:[],clear:[],change:[],changestop:[],cancel:[],swatchselect:[]};constructor(t){this.options=t=Object.assign({...Pickr.DEFAULT_OPTIONS},t);const{swatches:e,components:o,theme:i,sliders:s,lockOpacity:n,padding:r}=t;["nano","monolith"].includes(i)&&!s&&(t.sliders="h"),o.interaction||(o.interaction={});const{preview:a,opacity:l,hue:c,palette:p}=o;o.opacity=!n&&l,o.palette=p||a||l||c,this._preBuild(),this._buildComponents(),this._bindEvents(),this._initGradient(),this._finalBuild(),e&&e.length&&e.forEach((t=>this.addSwatch(t)));const{button:h,app:d}=this._root;this._nanopop=createPopper(h,d,{margin:r}),h.setAttribute("role","button"),h.setAttribute("aria-label",this._t("btn:toggle"));const u=this;this._setupAnimationFrame=requestAnimationFrame((function e(){if(!d.offsetWidth)return requestAnimationFrame(e);u.setColor(t.default),u._rePositioningPicker(),t.defaultRepresentation&&(u._representation=t.defaultRepresentation,u.setColorRepresentation(u._representation)),t.showAlways&&u.show(),u._initializingActive=!1,u._emit("init")}))}static create=t=>new Pickr(t);_preBuild(){const{options:t}=this;for(const e of["el","container"])t[e]=_.resolveElement(t[e]);this._root=buildPickr(this),t.useAsButton&&(this._root.button=t.el),t.container.appendChild(this._root.root)}_finalBuild(){const t=this.options,e=this._root;if(t.container.removeChild(e.root),t.inline){const o=t.el.parentElement;t.el.nextSibling?o.insertBefore(e.app,t.el.nextSibling):o.appendChild(e.app)}else t.container.appendChild(e.app);t.useAsButton?t.inline&&t.el.remove():t.el.parentNode.replaceChild(e.root,t.el),t.disabled&&this.disable(),t.comparison||(e.button.style.transition="none",t.useAsButton||(e.preview.lastColor.style.transition="none")),this.hide()}_buildComponents(){const t=this,e=this.options.components,o=(t.options.sliders||"v").repeat(2),[i,s]=o.match(/^[vh]+$/g)?o:[],n=()=>this._color||(this._color=this._lastColor.clone()),r={palette:Moveable({element:t._root.palette.picker,wrapper:t._root.palette.palette,onstop:()=>t._emit("changestop","slider",t),onchange(o,i){if(!e.palette)return;const s=n(),{_root:r,options:a}=t,{lastColor:l,currentColor:c}=r.preview;t._recalc&&(s.s=100*o,s.v=100-100*i,s.v<0&&(s.v=0),t._updateOutput("slider"));const p=s.toRGBA().toString(0);this.element.style.background=p,this.wrapper.style.background=`\n                        linear-gradient(to top, rgba(0, 0, 0, ${s.a}), transparent),\n                        linear-gradient(to left, hsla(${s.h}, 100%, 50%, ${s.a}), rgba(255, 255, 255, ${s.a}))\n                    `,a.comparison?a.useAsButton||t._lastColor||l.style.setProperty("--pcr-color",p):(r.button.style.setProperty("--pcr-color",p),r.button.classList.remove("clear"));const h=s.toHEXA().toString();for(const{el:e,color:o}of t._swatchColors)e.classList[h===o.toHEXA().toString()?"add":"remove"]("pcr-active");c.style.setProperty("--pcr-color",p)}}),hue:Moveable({lock:"v"===s?"h":"v",element:t._root.hue.picker,wrapper:t._root.hue.slider,onstop:()=>t._emit("changestop","slider",t),onchange(o){if(!e.hue||!e.palette)return;const i=n();t._recalc&&(i.h=360*o),this.element.style.backgroundColor=`hsl(${i.h}, 100%, 50%)`,r.palette.trigger()}}),opacity:Moveable({lock:"v"===i?"h":"v",element:t._root.opacity.picker,wrapper:t._root.opacity.slider,onstop:()=>t._emit("changestop","slider",t),onchange(o){if(!e.opacity||!e.palette)return;const i=n();t._recalc&&(i.a=Math.round(100*o)/100),this.element.style.background=`rgba(0, 0, 0, ${i.a})`,r.palette.trigger()}}),selectable:Selectable({elements:t._root.interaction.options,className:"active",onchange(e){t._representation=e.target.getAttribute("data-type").toUpperCase(),t._recalc&&t._updateOutput("swatch")}})};this._components=r}_bindEvents(){const{_root:t,options:e}=this,o=[_.on(t.interaction.clear,"click",(()=>this._clearColor())),_.on([t.interaction.cancel,t.preview.lastColor],"click",(()=>{this.setHSVA(...(this._lastColor||this._color).toHSVA(),!0),this._emit("cancel")})),_.on(t.interaction.save,"click",(()=>{!this.applyColor()&&!e.showAlways&&this.hide()})),_.on(t.interaction.result,["keyup","input"],(t=>{this.setColor(t.target.value,!0)&&!this._initializingActive&&(this._emit("change",this._color,"input",this),this._emit("changestop","input",this)),t.stopImmediatePropagation()})),_.on(t.interaction.result,["focus","blur"],(t=>{this._recalc="blur"===t.type,this._recalc&&this._updateOutput(null)})),_.on([t.palette.palette,t.palette.picker,t.hue.slider,t.hue.picker,t.opacity.slider,t.opacity.picker],["mousedown","touchstart"],(()=>this._recalc=!0),{passive:!0})];if(!e.showAlways){const i=e.closeWithKey;o.push(_.on(t.button,"click",(()=>this.isOpen()?this.hide():this.show())),_.on(document,"keyup",(t=>this.isOpen()&&(t.key===i||t.code===i)&&this.hide())),_.on(document,["touchstart","mousedown"],(e=>{this.isOpen()&&!_.eventPath(e).some((e=>e===t.app||e===t.button))&&this.hide()}),{capture:!0}))}if(e.adjustableNumbers){const e={rgba:[255,255,255,1],hsva:[360,100,100,1],hsla:[360,100,100,1],cmyk:[100,100,100,100]};_.adjustableInputNumbers(t.interaction.result,((t,o,i)=>{const s=e[this.getColorRepresentation().toLowerCase()];if(s){const e=s[i],n=t+(e>=100?1e3*o:o);return n<=0?0:Number((n<e?n:e).toPrecision(3))}return t}))}if(e.autoReposition&&!e.inline){let t=null;const i=this;o.push(_.on(window,["scroll","resize"],(()=>{i.isOpen()&&(e.closeOnScroll&&i.hide(),null===t?(t=setTimeout((()=>t=null),100),requestAnimationFrame((function e(){i._rePositioningPicker(),null!==t&&requestAnimationFrame(e)}))):(clearTimeout(t),t=setTimeout((()=>t=null),100)))}),{capture:!0}))}this._eventBindings=o}_initGradient(){const{_root:t,options:e}=this,o=t.gradient;o&&(this._gradientState={enabled:e.gradient.enabled,type:e.gradient.type,angle:e.gradient.angle,activeColor:0,colors:e.gradient.colors.map((t=>{const{values:e}=this._parseLocalColor(t);return HSVaColor(...e)}))},o.gradientEnabled.checked=e.gradient.enabled,o.gradientType.value=e.gradient.type,o.gradientAngle.value=e.gradient.angle,this._updateGradientColors(),this._bindGradientEvents())}_bindGradientEvents(){const{_root:t}=this,e=t.gradient;e&&(_.on(e.gradientEnabled,"change",(()=>{this._gradientState.enabled=e.gradientEnabled.checked,this._updateGradientColors(),this._updateOutput("gradient")})),_.on(e.gradientType,"change",(()=>{this._gradientState.type=e.gradientType.value,this._updateGradientColors(),this._updateOutput("gradient")})),_.on(e.gradientAngle,"input",(()=>{this._gradientState.angle=parseInt(e.gradientAngle.value),this._updateGradientColors(),this._updateOutput("gradient")})),_.on([e.color1,e.color2],"click",(t=>{if(!this._gradientState||!this._gradientState.colors)return;const o=t.target===e.color1?0:1;this._gradientState.activeColor=o,e.color1.classList.toggle("active",0===o),e.color2.classList.toggle("active",1===o);const i=this._gradientState.colors[o];i&&"function"==typeof i.toHSVA&&this.setHSVA(...i.toHSVA(),!0)})),this.on("change",(t=>{if(this._gradientState?.enabled&&this._gradientState?.colors){const e=this._gradientState.activeColor;"number"==typeof e&&this._gradientState.colors[e]&&(this._gradientState.colors[e]=t,this._updateGradientColors())}})))}_updateGradientColors(){const{_root:t,_gradientState:e}=this,o=t.gradient;if(!o||!e)return;o.colors.querySelectorAll(".pcr-gradient-color").forEach(((t,o)=>{e.colors[o]&&t.style.setProperty("--pcr-color",e.colors[o].toRGBA())}));const{type:i,angle:s,colors:n}=e,r="linear"===i?`linear-gradient(${s}deg, ${n[0].toRGBA()}, ${n[1].toRGBA()})`:"radial"===i?`radial-gradient(circle, ${n[0].toRGBA()}, ${n[1].toRGBA()})`:`conic-gradient(from ${s}deg, ${n[0].toRGBA()}, ${n[1].toRGBA()})`;o.preview.style.background=r}_rePositioningPicker(){const{options:t}=this;if(!t.inline){if(!this._nanopop.update({container:document.body.getBoundingClientRect(),position:t.position})){const t=this._root.app,e=t.getBoundingClientRect();t.style.top=(window.innerHeight-e.height)/2+"px",t.style.left=(window.innerWidth-e.width)/2+"px"}}}_updateOutput(t){const{_root:e,_color:o,options:i,_gradientState:s}=this;if(e.interaction.type()){const t=`to${e.interaction.type().getAttribute("data-type")}`;e.interaction.result.value="function"==typeof o[t]?o[t]().toString(i.outputPrecision):""}if(s?.enabled){const{type:t,angle:o,colors:i}=this._gradientState,s="linear"===t?`linear-gradient(${o}deg, ${i[0].toRGBA()}, ${i[1].toRGBA()})`:"radial"===t?`radial-gradient(circle, ${i[0].toRGBA()}, ${i[1].toRGBA()})`:`conic-gradient(from ${o}deg, ${i[0].toRGBA()}, ${i[1].toRGBA()})`;e.interaction.result&&(e.interaction.result.value=s)}!this._initializingActive&&this._recalc&&this._emit("change",o,t,this)}_clearColor(t=!1){const{_root:e,options:o}=this;o.useAsButton||e.button.style.setProperty("--pcr-color","rgba(0, 0, 0, 0.15)"),e.button.classList.add("clear"),o.showAlways||this.hide(),this._lastColor=null,this._initializingActive||t||(this._emit("save",null),this._emit("clear"))}_parseLocalColor(t){const{values:e,type:o,a:i}=parseToHSVA(t),{lockOpacity:s}=this.options,n=void 0!==i&&1!==i;return e&&3===e.length&&(e[3]=void 0),{values:!e||s&&n?null:e,type:o}}_t(t){return this.options.i18n[t]||Pickr.I18N_DEFAULTS[t]}_emit(t,...e){this._eventListener[t].forEach((t=>t(...e,this)))}on(t,e){return this._eventListener[t].push(e),this}off(t,e){const o=this._eventListener[t]||[],i=o.indexOf(e);return~i&&o.splice(i,1),this}addSwatch(t){const{values:e}=this._parseLocalColor(t);if(e){const{_swatchColors:t,_root:o}=this,i=HSVaColor(...e),s=_.createElementFromString(`<button type="button" style="--pcr-color: ${i.toRGBA().toString(0)}" aria-label="${this._t("btn:swatch")}"/>`);return o.swatches.appendChild(s),t.push({el:s,color:i}),this._eventBindings.push(_.on(s,"click",(()=>{this.setHSVA(...i.toHSVA(),!0),this._emit("swatchselect",i),this._emit("change",i,"swatch",this)}))),!0}return!1}removeSwatch(t){const e=this._swatchColors[t];if(e){const{el:o}=e;return this._root.swatches.removeChild(o),this._swatchColors.splice(t,1),!0}return!1}applyColor(t=!1){const{preview:e,button:o}=this._root,i=this._color.toRGBA().toString(0);return e.lastColor.style.setProperty("--pcr-color",i),this.options.useAsButton||o.style.setProperty("--pcr-color",i),o.classList.remove("clear"),this._lastColor=this._color.clone(),this._initializingActive||t||this._emit("save",this._color),this}destroy(){cancelAnimationFrame(this._setupAnimationFrame),this._eventBindings.forEach((t=>_.off(...t))),Object.keys(this._components).forEach((t=>this._components[t].destroy()))}destroyAndRemove(){this.destroy();const{root:t,app:e}=this._root;t.parentElement&&t.parentElement.removeChild(t),e.parentElement.removeChild(e),Object.keys(this).forEach((t=>this[t]=null))}hide(){return!!this.isOpen()&&(this._root.app.classList.remove("visible"),this._emit("hide"),!0)}show(){return!this.options.disabled&&!this.isOpen()&&(this._root.app.classList.add("visible"),this._rePositioningPicker(),this._emit("show",this._color),this)}isOpen(){return this._root.app.classList.contains("visible")}setHSVA(t=360,e=0,o=0,i=1,s=!1){const n=this._recalc;if(this._recalc=!1,t<0||t>360||e<0||e>100||o<0||o>100||i<0||i>1)return!1;this._color=HSVaColor(t,e,o,i);const{hue:r,opacity:a,palette:l}=this._components;return r.update(t/360),a.update(i),l.update(e/100,1-o/100),s||this.applyColor(),n&&this._updateOutput(),this._recalc=n,!0}setColor(t,e=!1){if(null===t)return this._clearColor(e),!0;const{values:o,type:i}=this._parseLocalColor(t);if(o){const t=i.toUpperCase(),{options:s}=this._root.interaction,n=s.find((e=>e.getAttribute("data-type")===t));if(n&&!n.hidden)for(const t of s)t.classList[t===n?"add":"remove"]("active");return!!this.setHSVA(...o,e)&&this.setColorRepresentation(t)}return!1}setColorRepresentation(t){return t=t.toUpperCase(),!!this._root.interaction.options.find((e=>e.getAttribute("data-type").startsWith(t)&&!e.click()))}getColorRepresentation(){return this._representation}getColor(){return this._color}getSelectedColor(){return this._lastColor}getRoot(){return this._root}disable(){return this.hide(),this.options.disabled=!0,this._root.button.classList.add("disabled"),this}enable(){return this.options.disabled=!1,this._root.button.classList.remove("disabled"),this}}